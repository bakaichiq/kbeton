# KBeton Bot ERP (Telegram + PostgreSQL)

Production-ready —Å–∏—Å—Ç–µ–º–∞ —É—á–µ—Ç–∞ –∏ –æ—Ç—á–µ—Ç–Ω–æ—Å—Ç–∏ –±–µ—Ç–æ–Ω–Ω–æ–≥–æ –∑–∞–≤–æ–¥–∞ –Ω–∞ –±–∞–∑–µ **Telegram-–±–æ—Ç–∞ + –æ–±–ª–∞—á–Ω–æ–π –ë–î (PostgreSQL)**.

## –ß—Ç–æ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ

- Telegram Bot (**aiogram 3**) —Å –º–µ–Ω—é:
  - üìä –î–∞—à–±–æ—Ä–¥
  - üí∞ –§–∏–Ω–∞–Ω—Å—ã: P&L, —Å—Ç–∞—Ç—å–∏, –ø—Ä–∞–≤–∏–ª–∞ –º–∞–ø–ø–∏–Ω–≥–∞, –Ω–µ—Ä–∞–∑–æ–±—Ä–∞–Ω–Ω–æ–µ (—Ä—É—á–Ω–∞—è —Ä–∞–∑–º–µ—Ç–∫–∞), –∏–º–ø–æ—Ä—Ç –≤–∑–∞–∏–º–æ—Ä–∞—Å—á–µ—Ç–æ–≤, —Ü–µ–Ω—ã (FinDir/Admin)
  - üè≠ –ü—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–æ: –∑–∞–∫—Ä—ã—Ç–∏–µ —Å–º–µ–Ω—ã –æ–ø–µ—Ä–∞—Ç–æ—Ä–æ–º, —Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–∏–µ HeadProd
  - üì¶ –°–∫–ª–∞–¥: –≤—ã–¥–∞—á–∞/—Å–ø–∏—Å–∞–Ω–∏–µ, –æ—Å—Ç–∞—Ç–∫–∏, –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–µ –æ—Å—Ç–∞—Ç–∫–∏ –∏ –∞–ª–µ—Ä—Ç—ã, –∏–Ω–≤–µ–Ω—Ç–∞—Ä–∏–∑–∞—Ü–∏—è
  - ‚öôÔ∏è –ê–¥–º–∏–Ω: –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏/—Ä–æ–ª–∏, —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫–∏
- API (**FastAPI**): `/health`, `/pnl`, `/pnl.xlsx`, `/prices/current`
- –ò–º–ø–æ—Ä—Ç XLSX –≤–∑–∞–∏–º–æ—Ä–∞—Å—á–µ—Ç–æ–≤ —á–µ—Ä–µ–∑ S3/MinIO + Celery worker
- –ö–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏—è —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π –ø–æ –ø—Ä–∞–≤–∏–ª–∞–º (contains/regex + priority)
- –í–µ—Ä—Å–∏–æ–Ω–Ω–æ—Å—Ç—å —Ü–µ–Ω (valid_from, –∏—Å—Ç–æ—Ä–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π)
- –ê—É–¥–∏—Ç –¥–µ–π—Å—Ç–≤–∏–π (–∫—Ç–æ/—á—Ç–æ/–∫–æ–≥–¥–∞/–ø—ç–π–ª–æ–∞–¥)
- Celery Beat:
  - –µ–∂–µ–¥–Ω–µ–≤–Ω—ã–π P&L (–µ—Å–ª–∏ –∑–∞–¥–∞–Ω `TELEGRAM_DEFAULT_CHAT_ID`)
  - –∞–ª–µ—Ä—Ç—ã –ø–æ —Å–∫–ª–∞–¥—É (min_qty)

---

## –î–µ—Ñ–æ–ª—Ç—ã (—è–≤–Ω–æ —Ñ–∏–∫—Å–∏—Ä—É–µ–º)

- –í–∞–ª—é—Ç–∞ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é: **KGS**
- –¢–∞–π–º–∑–æ–Ω–∞ –æ—Ç—á–µ—Ç–æ–≤: **Asia/Bishkek**
- –¶–µ–Ω—ã:
  - –±–µ—Ç–æ–Ω: `kind=concrete`, `item_key = –º–∞—Ä–∫–∞`, –Ω–∞–ø—Ä–∏–º–µ—Ä `M300`
  - –±–ª–æ–∫–∏: `kind=blocks`, `item_key = blocks`
- RBAC:
  - –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è –ø–æ Telegram ID
  - –Ω–æ–≤—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø—Ä–∏ –ø–µ—Ä–≤–æ–º /start —Å–æ–∑–¥–∞–µ—Ç—Å—è –∫–∞–∫ `Viewer`
  - Admin –∏–º–µ–µ—Ç –¥–æ—Å—Ç—É–ø –∫–æ –≤—Å–µ–º –∫–æ–º–∞–Ω–¥–∞–º

---

## –ë—ã—Å—Ç—Ä—ã–π —Å—Ç–∞—Ä—Ç (Docker)

### 1) –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –æ–∫—Ä—É–∂–µ–Ω–∏—è
–°–∫–æ–ø–∏—Ä—É–π—Ç–µ `.env.example` ‚Üí `.env` –∏ –∑–∞–¥–∞–π—Ç–µ –º–∏–Ω–∏–º—É–º:

- `TELEGRAM_BOT_TOKEN=...` (–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)
- `POSTGRES_PASSWORD=...` (–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)
- `S3_ACCESS_KEY_ID=...` –∏ `S3_SECRET_ACCESS_KEY=...` (–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)
- `API_AUTH_ENABLED=true` –∏ `API_TOKEN=...` –¥–ª—è –∑–∞—â–∏—Ç—ã API
- (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ) `TELEGRAM_DEFAULT_CHAT_ID=...` –¥–ª—è —Ä–∞—Å—Å—ã–ª–æ–∫

### 2) –ó–∞–ø—É—Å–∫
```bash
cd kbeton_bot_erp_full
docker build -f docker/Dockerfile.base -t kbeton-base:latest .
docker compose up -d --build
```

–ü–æ—Å–ª–µ —Å—Ç–∞—Ä—Ç–∞:
- API: http://localhost:8000/health
- MinIO Console: http://localhost:9001 (–ª–æ–≥–∏–Ω/–ø–∞—Ä–æ–ª—å –∏–∑ `.env`)

> –ü—Ä–∏ `API_AUTH_ENABLED=true` —ç–Ω–¥–ø–æ–∏–Ω—Ç—ã `/pnl`, `/pnl.xlsx`, `/prices/current` —Ç—Ä–µ–±—É—é—Ç —Ç–æ–∫–µ–Ω –≤ `Authorization: Bearer <API_TOKEN>` –∏–ª–∏ `X-API-Key`.

> –ú–∏–≥—Ä–∞—Ü–∏–∏ –≤—ã–ø–æ–ª–Ω—è—é—Ç—Å—è —Å–µ—Ä–≤–∏—Å–æ–º `migrate` –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ.

---

## –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –∏ —Ä–æ–ª–µ–π

### –°–æ–∑–¥–∞—Ç—å/–æ–±–Ω–æ–≤–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
```bash
docker compose run --rm api python scripts/create_user.py --tg-id 123456789 --name "Bakai" --role Admin
```

### –ù–∞–∑–Ω–∞—á–∏—Ç—å —Ä–æ–ª—å
```bash
docker compose run --rm api python scripts/set_role.py --tg-id 123456789 --role FinDir
```

### Seed demo data (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
–°–æ–∑–¥–∞—Å—Ç —Å—Ç–∞—Ç—å–∏, –ø—Ä–∞–≤–∏–ª–∞, —Ä–∞—Å—Ö–æ–¥–Ω–∏–∫–∏, —Ü–µ–Ω—ã.
```bash
docker compose run --rm api python scripts/seed_demo.py
```

---

## –†–∞–±–æ—Ç–∞ –≤ Telegram

1) –û—Ç–∫—Ä–æ–π—Ç–µ –±–æ—Ç–∞ ‚Üí `/start`  
2) Admin/FinDir:
   - üí∞ –§–∏–Ω–∞–Ω—Å—ã ‚Üí üß© –ù–µ—Ä–∞–∑–æ–±—Ä–∞–Ω–Ω–æ–µ ‚Üí –Ω–∞–∑–Ω–∞—á–∏—Ç—å —Å—Ç–∞—Ç—å—é ‚Üí (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ) –∞–≤—Ç–æ—Å–æ–∑–¥–∞—Ç—å –ø—Ä–∞–≤–∏–ª–æ contains
   - üí∞ –§–∏–Ω–∞–Ω—Å—ã ‚Üí üìÑ P&L ‚Üí –≤—ã–±—Ä–∞—Ç—å –ø–µ—Ä–∏–æ–¥ (xlsx –≤—ã–≥—Ä—É–∑–∫–∞ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è –±–æ—Ç–æ–º)
   - üí∞ –§–∏–Ω–∞–Ω—Å—ã ‚Üí üì¶ –°—Ç–∞—Ç—É—Å –∏–º–ø–æ—Ä—Ç–∞
   - üí∞ –§–∏–Ω–∞–Ω—Å—ã ‚Üí üìê –ü—Ä–∞–≤–∏–ª–∞ –º–∞–ø–ø–∏–Ω–≥–∞ (contains/regex + priority)
   - üí∞ –§–∏–Ω–∞–Ω—Å—ã ‚Üí üè∑Ô∏è –¶–µ–Ω—ã ‚Üí —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Ü–µ–Ω—É –º–∞—Ä–æ–∫ –±–µ—Ç–æ–Ω–∞ –∏ –±–ª–æ–∫–æ–≤
   - üí∞ –§–∏–Ω–∞–Ω—Å—ã ‚Üí üì• –ó–∞–≥—Ä—É–∑–∏—Ç—å –≤–∑–∞–∏–º–æ—Ä–∞—Å—á–µ—Ç—ã (–∫–æ–Ω—Ç—Ä–∞–≥–µ–Ω—Ç—ã)

3) Operator:
   - üè≠ –ü—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–æ ‚Üí –ó–∞–∫—Ä—ã—Ç—å —Å–º–µ–Ω—É (–ø–æ—à–∞–≥–æ–≤—ã–π –≤–≤–æ–¥)

4) HeadProd:
   - üè≠ –ü—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–æ ‚Üí –°–º–µ–Ω—ã –Ω–∞ —Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–∏–µ ‚Üí approve/reject
   - üè≠ –ü—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–æ ‚Üí –í—ã–ø—É—Å–∫/KPI (–∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 7 –¥–Ω–µ–π)

5) Warehouse:
   - üì¶ –°–∫–ª–∞–¥ ‚Üí –í—ã–¥–∞—Ç—å / –°–ø–∏—Å–∞—Ç—å / –ò–Ω–≤–µ–Ω—Ç–∞—Ä–∏–∑–∞—Ü–∏—è / –û—Å—Ç–∞—Ç–∫–∏
6) –£–∑–Ω–∞—Ç—å —Å–≤–æ–π TG ID –∏ ID —á–∞—Ç–∞:
   - –∫–æ–º–∞–Ω–¥–∞ `/id`
7) –ü–æ–º–æ—â—å –∏ —Å–±—Ä–æ—Å –≤–≤–æ–¥–∞:
   - `/help` ‚Äî –∫—Ä–∞—Ç–∫–∞—è —à–ø–∞—Ä–≥–∞–ª–∫–∞
   - `/cancel` –∏–ª–∏ `–æ—Ç–º–µ–Ω–∞` ‚Äî –≤—ã–π—Ç–∏ –∏–∑ —Ç–µ–∫—É—â–µ–≥–æ –≤–≤–æ–¥–∞
   - `/today`, `/week`, `/month` ‚Äî –±—ã—Å—Ç—Ä—ã–π P&L
   - `/audit` ‚Äî –ø–æ—Å–ª–µ–¥–Ω–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è (Admin)
8) –ö–æ–Ω—Ç—Ä–∞–≥–µ–Ω—Ç—ã:
   - üí∞ –§–∏–Ω–∞–Ω—Å—ã ‚Üí –ö–æ–Ω—Ç—Ä–∞–≥–µ–Ω—Ç—ã/–ó–∞–¥–æ–ª–∂–µ–Ω–Ω–æ—Å—Ç—å (—Å–Ω–∏–º–∫–∏) ‚Üí –≤–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –¥–ª—è –∫–∞—Ä—Ç–æ—á–∫–∏

---

## –ò–º–ø–æ—Ä—Ç XLSX

### –í–∑–∞–∏–º–æ—Ä–∞—Å—á–µ—Ç—ã (–∫–æ–Ω—Ç—Ä–∞–≥–µ–Ω—Ç—ã)
–ö–æ–º–∞–Ω–¥–∞ –±–æ—Ç–∞: **üì• –ó–∞–≥—Ä—É–∑–∏—Ç—å –≤–∑–∞–∏–º–æ—Ä–∞—Å—á–µ—Ç—ã (–∫–æ–Ω—Ç—Ä–∞–≥–µ–Ω—Ç—ã)**  
–°–Ω–∏–º–∫–∏ —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è (snapshot_date = –¥–∞—Ç–∞ –∏–º–ø–æ—Ä—Ç–∞), –∏–º–µ–Ω–∞ –Ω–æ—Ä–º–∞–ª–∏–∑—É—é—Ç—Å—è.

–ü—Ä–∏–º–µ—Ä —à–∞–±–ª–æ–Ω–∞:
- `samples/counterparty_snapshot_template.xlsx`

---

## –¢–µ—Å—Ç—ã

–õ–æ–∫–∞–ª—å–Ω–æ (–≤–Ω–µ docker):
```bash
pip install -r requirements.txt
pytest -q
```

---

## –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è

- `apps/api` ‚Äî FastAPI API
- `apps/bot` ‚Äî Telegram bot (aiogram 3)
- `apps/worker` ‚Äî Celery worker/beat –∑–∞–¥–∞—á–∏
- `kbeton/models` ‚Äî SQLAlchemy –º–æ–¥–µ–ª–∏
- `kbeton/importers` ‚Äî –ø–∞—Ä—Å–µ—Ä—ã XLSX
- `kbeton/services` ‚Äî –¥–æ–º–µ–Ω–Ω–∞—è –ª–æ–≥–∏–∫–∞ (auth/audit/s3/mapping/pricing)
- `kbeton/reports` ‚Äî P&L –∏ —ç–∫—Å–ø–æ—Ä—Ç
- `alembic` ‚Äî –º–∏–≥—Ä–∞—Ü–∏–∏
- `scripts` ‚Äî –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–∏–µ (—Å–æ–∑–¥–∞–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π/—Ä–æ–ª–µ–π/seed)
- `samples` ‚Äî —à–∞–±–ª–æ–Ω—ã XLSX
- `tests` ‚Äî unit tests

---

## –ö–æ–º–∞–Ω–¥—ã –æ–±—Å–ª—É–∂–∏–≤–∞–Ω–∏—è

–û—Ç–∫—Ä—ã—Ç—å psql:
```bash
docker compose exec postgres psql -U kbeton -d kbeton
```

–ü—Ä–æ—Å–º–æ—Ç—Ä –ª–æ–≥–æ–≤:
```bash
docker compose logs -f api
docker compose logs -f bot
docker compose logs -f worker
```

## –ê–≤—Ç–æ–¥–µ–ø–ª–æ–π –ø–æ—Å–ª–µ push –≤ main

–ï—Å–ª–∏ –Ω—É–∂–Ω–æ, —á—Ç–æ–±—ã –Ω–∞ –¥—Ä—É–≥–æ–º –∫–æ–º–ø—å—é—Ç–µ—Ä–µ (–ª–æ–∫–∞–ª—å–Ω—ã–π —Å–µ—Ä–≤–µ—Ä) –ø–æ—Å–ª–µ `git push` –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≤—ã–ø–æ–ª–Ω—è–ª–∏—Å—å `git pull` –∏ `docker compose up -d --build`, –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ workflow:

- `.github/workflows/deploy-on-push.yml`

–í GitHub —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–∏ –¥–æ–±–∞–≤—å—Ç–µ Secrets:

- `DEPLOY_HOST` ‚Äî IP/–¥–æ–º–µ–Ω —Å–µ—Ä–≤–µ—Ä–Ω–æ–≥–æ –∫–æ–º–ø—å—é—Ç–µ—Ä–∞
- `DEPLOY_USER` ‚Äî SSH –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å
- `DEPLOY_PATH` ‚Äî –ø—É—Ç—å –∫ –ø—Ä–æ–µ–∫—Ç—É –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ (–Ω–∞–ø—Ä–∏–º–µ—Ä `/opt/kbeton_bot_erp_full`)
- `DEPLOY_SSH_KEY` ‚Äî –ø—Ä–∏–≤–∞—Ç–Ω—ã–π SSH –∫–ª—é—á (ed25519), —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–π –ø—É–±–ª–∏—á–Ω–æ–º—É –∫–ª—é—á—É –≤ `~/.ssh/authorized_keys` –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ

–¢—Ä–µ–±–æ–≤–∞–Ω–∏—è –Ω–∞ —Å–µ—Ä–≤–µ—Ä–Ω–æ–º –∫–æ–º–ø—å—é—Ç–µ—Ä–µ:

- —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω Docker + Docker Compose
- —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π —É–∂–µ —Å–∫–ª–æ–Ω–∏—Ä–æ–≤–∞–Ω –≤ `DEPLOY_PATH`
- SSH –¥–æ—Å—Ç—É–ø —Ä–∞–∑—Ä–µ—à–µ–Ω
